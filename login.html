<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Project Cost</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00c6ff;
            --secondary: #0072ff;
            --dark: #0a0a1a;
            --darker: #050510;
            --light: #f0f8ff;
            --accent: #ff2d75;
            --success: #00e676;
            --card-bg: rgba(15, 20, 40, 0.7);
            --card-border: rgba(0, 198, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 198, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 45, 117, 0.1) 0%, transparent 20%);
            z-index: -1;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 15px;
            border: 1px solid var(--card-border);
            box-shadow: 0 0 30px rgba(0, 198, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--accent));
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            font-size: 3rem;
            color: var(--primary);
            text-shadow: 0 0 15px rgba(0, 198, 255, 0.5);
            margin-bottom: 15px;
        }

        .logo h1 {
            font-size: 2.2rem;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(10, 20, 40, 0.5);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 198, 255, 0.3);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            margin-top: 10px;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 198, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /*
         * The OTP form is hidden by default using the `.hidden` class rather than
         * the `.otp-container` class. We remove the `display: none` here and rely
         * on the `.hidden` class added to the element in the markup. This allows
         * the JavaScript to show the OTP form by toggling the `hidden` class.
         */
        .otp-container {
            /* styling for OTP container goes here (no display none) */
        }

        .otp-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid rgba(0, 198, 255, 0.3);
            border-radius: 8px;
            background: rgba(10, 20, 40, 0.5);
            color: white;
        }

        .otp-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 198, 255, 0.3);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--accent);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 30px;
            color: #777;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .login-container {
                margin: 20px;
                padding: 20px;
            }
            
            .otp-input {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h1>Minor Project</h1>
        </div>
        
        <div id="login-form">
            <div class="form-group">
                <label for="email">Team Member Email</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your own email">
            </div>
            <button id="send-otp-btn" class="btn btn-primary">Send OTP</button>
        </div>
        
        <!--
            The OTP form is initially hidden using the `.hidden` class. When a user
            successfully requests an OTP, the script will remove the `.hidden` class to
            reveal this form. Relying on the `.hidden` class (rather than `.otp-container`)
            makes it possible to toggle visibility via JavaScript.
        -->
        <div id="otp-form" class="otp-container hidden">
            <div class="form-group">
                <label>Enter 6-digit Code</label>
                <div class="otp-inputs">
                    <input type="text" class="otp-input" maxlength="1" data-index="0">
                    <input type="text" class="otp-input" maxlength="1" data-index="1">
                    <input type="text" class="otp-input" maxlength="1" data-index="2">
                    <input type="text" class="otp-input" maxlength="1" data-index="3">
                    <input type="text" class="otp-input" maxlength="1" data-index="4">
                    <input type="text" class="otp-input" maxlength="1" data-index="5">
                </div>
                <p id="otp-message">We've sent a code to your email</p>
            </div>
            <button id="verify-otp-btn" class="btn btn-primary">Verify Code</button>
            <button id="resend-otp-btn" class="btn btn-secondary">Resend OTP</button>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
        
        <footer>
            <p>Project Expense Tracker &copy; ๏ ʟᴜᴍɪɴᴏ ⇗ ˣᵖ 2025</p>
        </footer>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">Operation completed successfully!</div>

    <!--
        This script handles the login and OTP flow. In order to use modern ECMAScript imports
        (e.g. `import { createClient } from ...`) in the browser, the script must be marked
        as a module. Without `type="module"` the browser treats it as a classic script and
        will throw a "Cannot use import statement outside a module" syntax error when it
        encounters an `import` statement. Adding the `type="module"` attribute instructs
        the browser to interpret the script as an ES module, enabling the import syntax.
    -->
    <script type="module">
        // Import Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // Supabase credentials (REPLACE THESE WITH YOUR ACTUAL Database URL & ANON KEY)
        const SUPABASE_URL = '' 
        const SUPABASE_ANON_KEY = ''

        // Create Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // DOM Elements
        const loginForm = document.getElementById('login-form')
        const otpForm = document.getElementById('otp-form')
        const loading = document.getElementById('loading')
        const userEmail = document.getElementById('email')
        const otpInputs = document.querySelectorAll('.otp-input')
        const otpMessage = document.getElementById('otp-message')
        const notification = document.getElementById('notification')

        // Buttons
        const sendOTPBtn = document.getElementById('send-otp-btn')
        const verifyOTPBtn = document.getElementById('verify-otp-btn')
        const resendOTPBtn = document.getElementById('resend-otp-btn')

        // Current state
        let pendingEmail = ''
        let otpCode = ''

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message
            notification.className = 'notification'
            if (isError) {
                notification.classList.add('error')
            }
            notification.classList.add('show')

            setTimeout(() => {
                notification.classList.remove('show')
            }, 3000)
        }

        // Generate OTP (for demo purposes)
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString()
        }

        // Send OTP (mock implementation)
        function sendOTP(email) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const otp = generateOTP()
                    console.log(`OTP sent to ${email}: ${otp}`)
                    otpCode = otp
                    resolve(otp)
                }, 1000)
            })
        }

        // Verify OTP using Supabase's verifyOtp method.
        // This replaces the previous mock implementation. It returns a promise
        // that resolves to true if the OTP is valid, or false otherwise.
        async function verifyOTP(enteredOTP) {
            try {
                const { data, error } = await supabase.auth.verifyOtp({
                    email: pendingEmail,
                    token: enteredOTP,
                    type: 'email'
                });
                if (error) {
                    console.error('Supabase verifyOtp error:', error);
                    return false;
                }
                // If no error, the user is verified and logged in
                return true;
            } catch (err) {
                console.error('Unexpected error verifying OTP:', err);
                return false;
            }
        }

        // OTP Input Handling
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1) {
                    if (index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus()
                    }
                }
            })

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    otpInputs[index - 1].focus()
                }
            })
        })

        // Get OTP from inputs
        function getOTP() {
            return Array.from(otpInputs).map(input => input.value).join('')
        }

        // Clear OTP inputs
        function clearOTP() {
            otpInputs.forEach(input => input.value = '')
            otpInputs[0].focus()
        }

        // Event Listeners
        sendOTPBtn.addEventListener('click', async () => {
            const email = userEmail.value.trim()

            if (!email) {
                showNotification('Please enter your email address', true)
                return
            }

            loading.classList.remove('hidden')

            try {
                // Send real OTP via Supabase
                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        shouldCreateUser: true,
                        emailRedirectTo: window.location.href
                    }
                })

                if (error) throw error

                console.log('OTP sent successfully') // Debug log
                showNotification('OTP sent to your email. Please check your inbox.')
                loginForm.classList.add('hidden')
                otpForm.classList.remove('hidden')
                pendingEmail = email // Store email for verification
                clearOTP()
            } catch (error) {
                console.error('Error sending OTP:', error)
                showNotification('Failed to send OTP. Please try again.', true)
            } finally {
                loading.classList.add('hidden')
            }
        })

        verifyOTPBtn.addEventListener('click', async () => {
            const otp = getOTP()

            if (otp.length !== 6) {
                showNotification('Please enter a 6-digit code', true)
                return
            }

            loading.classList.remove('hidden')

            try {
            const isValid = await verifyOTP(otp);
                if (isValid) {
                    /**
                     * On successful OTP verification, attempt to fetch an existing
                     * user record using the provided email. The `users` table is
                     * expected to have columns: id (UUID), email, name, and avatar.
                     * If no record exists, prompt the user for their name and
                     * create a new user. This ensures that every authenticated
                     * member has an entry in the `users` table.
                     */
                    let existingUser = null;
                    try {
                        const { data, error } = await supabase
                            .from('users')
                            .select('*')
                            .eq('email', pendingEmail)
                            .single();
                        if (error && error.code !== 'PGRST116') {
                            // Unexpected error – log it but fall back to creation
                            console.error('Error querying users table:', error);
                        }
                        existingUser = data || null;
                    } catch (err) {
                        // If the row is not found, supabase throws; ignore
                        existingUser = null;
                    }
                    // If no user exists, ask for a name and insert
                    if (!existingUser) {
                        let name = '';
                        while (!name) {
                            name = prompt('Welcome! Please enter your name to continue:');
                            if (name === null) {
                                showNotification('Name is required to continue.', true);
                                loading.classList.add('hidden');
                                return;
                            }
                            name = name.trim();
                        }
                        const initials = name
                            .split(' ')
                            .map(part => part.charAt(0))
                            .join('')
                            .toUpperCase()
                            .slice(0, 2);
                        const { data: inserted, error: insertError } = await supabase
                            .from('users')
                            .insert({ email: pendingEmail, name: name, avatar: initials })
                            .select()
                            .single();
                        if (insertError) {
                            console.error('Error inserting user:', insertError);
                            showNotification('Failed to save your details. Please try again.', true);
                            loading.classList.add('hidden');
                            return;
                        }
                        existingUser = inserted;
                    }
                    // Prepare the currentUser object for localStorage. Use the
                    // avatar from the database if present, otherwise derive from
                    // the user name. This avatar is used throughout the app.
                    const avatar = existingUser.avatar || existingUser.name
                        .split(' ')
                        .map(part => part.charAt(0))
                        .join('')
                        .toUpperCase()
                        .slice(0, 2);
                    const user = {
                        id: existingUser.id,
                        email: pendingEmail,
                        name: existingUser.name,
                        avatar: avatar
                    };
                    // Persist the session locally and redirect to the main page
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    localStorage.setItem('isLoggedIn', 'true');
                    window.location.href = 'index.html';
                } else {
                    showNotification('Invalid OTP. Please try again.', true);
                }
            } catch (error) {
                showNotification('Verification failed. Please try again.', true);
            } finally {
                loading.classList.add('hidden');
            }
        });

        resendOTPBtn.addEventListener('click', async () => {
            if (!pendingEmail) {
                showNotification('No email found. Please enter your email again.', true)
                return
            }

            loading.classList.remove('hidden')

            try {
                // Resend OTP via Supabase
                const { error } = await supabase.auth.signInWithOtp({
                    email: pendingEmail,
                    options: {
                        shouldCreateUser: false,
                        emailRedirectTo: window.location.href
                    }
                })
                if (error) throw error
                clearOTP()
                showNotification('New OTP sent to your email')
            } catch (error) {
                showNotification('Failed to resend OTP. Please try again.', true)
            } finally {
                loading.classList.add('hidden')
            }
        })

        // Check if already logged in
        if (localStorage.getItem('isLoggedIn') === 'true') {
            window.location.href = 'index.html'
        }
    </script>
</body>
</html>
